# index.ts

The `index.ts` file within the `src/services` directory of the `ferrumnet/multiswap-validator-node` repository serves as a central point for exporting modules. This file essentially organizes and makes accessible the defined modules in the project for periodic tasks.

# axios.service.ts

The file `axios.service.ts` contains three primary functions related to HTTP operations using the `axios` library, each designed to interact with the MultiSwap backend. Below are detailed descriptions of each function:

### Function: `getTransactions`

This asynchronous function fetches a list of transactions with a specific status from the Multiswap backend API. It dynamically constructs the request URL based on the environment settings and includes authorization headers.

Parameters: None

Returns:

-   `Array`: A list of transactions if successful.
-   `null`: In case of an error during the HTTP request.

Details:

-   Base URL: Depending on whether the environment is local, it switches between the AWS environment's BASE URL and a local URL.
-   Headers: Includes an authorization token generated by `createAuthTokenForMultiswapBackend` and prefixed by a bearer token.
-   URL Parameters: Status set to "generatorSignatureCreated", public key from the environment, a limit of 20, and nodeType set to "validator".
-   Error Handling: Catches and logs any error that occurs during the Axios request.

### Function: `updateTransaction`

This asynchronous function sends a PUT request to update a specific transaction in the Multiswap backend. The transaction to update is identified by its hash, and it sends additional transaction data as part of the request body.

Parameters:

-   `txHash` (string): The hash of the transaction to update.
-   `body` (any): The new data for the transaction to be updated.

Returns:

-   Axios `Promise`: Resolves with the response data from the API or rejects with an error.

Details:

-   Base URL: Like the `getTransactions` function, it chooses the base URL based on the environment.
-   Headers: Includes an authorization token as in the `getTransactions` function.
-   URL: Includes the transaction hash and public key in the query parameters.
-   Error Handling: Managed by Axios and the function's caller through promise resolution and rejection.

These functions play a critical role in interacting with the backend services, especially in handling and updating transactions in different environments.

# signature.service.ts

Here's the documentation for each function in the `signature.service.ts` file from the `multiswap-validator-node` repository:

1.  getDataForSignature:

    -   Purpose: Assembles transaction data necessary for signature creation.
    -   Parameters:
        -   `job`: Contains job-related data.
        -   `decodedData`: Contains decoded data from a transaction.
        -   `transaction`: Represents the actual transaction.
    -   Returns: A Promise resolving to an object with assembled transaction data including various transaction details and cryptographic elements.
2.  getValidWithdrawalData:

    -   Purpose: Validates withdrawal data based on the current and decoded data.
    -   Parameters:
        -   `data`: The current transaction-related data.
        -   `decodedData`: Pre-existing decoded data for validation.
    -   Returns: A Promise that resolves to the validated withdrawal data if validation passes; otherwise, null.
3.  isValidSettledAmount:

    -   Purpose: Validates if the settled amount is within the acceptable range after accounting for slippage.
    -   Parameters:
        -   `slippage`: Allowed slippage percentage.
        -   `sourceChainId`: Blockchain ID of the source.
        -   `destinationChainId`: Blockchain ID of the destination.
        -   `destinationAmountIn`: Expected amount in the destination.
        -   `settledAmount`: Actual settled amount.
    -   Returns: A Promise that resolves to a boolean indicating if the settled amount is valid.
4.  createSignedPayment:

    -   Purpose: Generates a signed payment transaction.
    -   Parameters: Details of the payment including blockchain IDs, payee, amount, and cryptographic parameters.
    -   Returns: An object containing the signature and hash used for the payment.
5.  produceFoundaryHash and produceOneInchHash:

    -   Purpose: Generates cryptographic hashes for Foundary and One Inch transaction types, respectively.
    -   Parameters: Details specific to each transaction type and cryptographic requirements.
    -   Returns: The generated hash for the transaction.
6.  domainSeparator:

    -   Purpose: Produces a domain separator hash used in cryptographic functions.
    -   Parameters:
        -   `web3`: Web3 instance.
        -   `chainId`: Blockchain ID.
        -   `contractAddress`: Address of the contract.
    -   Returns: The domain separator hash.
7.  validateSignature:

    -   Purpose: Validates a collection of signatures against provided hashes.
    -   Parameters:
        -   `job`: Job object containing transaction and signature details.
        -   `localSignatures`: Local signatures to validate against.
    -   Returns: Boolean indicating the validity of the signatures.
8.  isRecoverAddressValid:

    -   Purpose: Validates a recovered address using a signature and hash.
    -   Parameters:
        -   `signature`: Cryptographic signature.
        -   `hash`: Associated hash.
    -   Returns: Boolean indicating if the recovered address is valid.
9.  getDataForSalt:

    -   Purpose: Generates a salt data string based on transaction details.
    -   Parameters: Transaction data and flags indicating the purpose of the salt.
    -   Returns: A salt string based on transaction details.
10. getDecodedLogsDataIntoString:

    -   Purpose: Converts decoded log data into a concatenated string.
    -   Parameters:
        -   `decodedData`: Decoded data from transaction logs.
    -   Returns: Concatenated string of decoded log data.

This file heavily utilizes asynchronous operations and cryptographic functions to validate and handle blockchain transactions, specifically focusing on operations like data validation, signature creation, and cryptographic hash generation.

# transaction.service.ts

The file `transaction.service.ts` in the repository contains several key functions related to transaction handling for the multiswap validator node. Below is a detailed description of each function within this file:

### 1\. `fetchChainDataFromNetwork(tx: any)`

This function fetches chain data from the network based on the transaction details provided. It assembles a job request body containing details about the transaction, including RPC URLs, asset types, transaction IDs, and more. Depending on whether the source network is EVM or non-EVM, it either retrieves transaction receipts directly via web3 services or potentially through other services (commented out in the code, indicating possible non-EVM handling).

#### Parameters:

-   `tx`: The transaction object containing various details about the transaction.

#### Actions:

-   Assembles data for a job.
-   Fetches the transaction receipt.
-   Calls `verifyAndCreateSignature` if the transaction receipt indicates success.

### 2\. `verifyAndCreateSignature(job: any)`

Attempts to verify and create a signature for the job. It decodes transaction details and, depending on whether the destination is EVM or non-EVM, processes signatures and possibly updates the transaction.

#### Parameters:

-   `job`: An object containing job data and transaction details.

#### Actions:

-   Decodes transaction data.
-   Verifies signatures and updates the transaction accordingly.
-   Handles errors and logs them.

### 3\. `updateTransaction(job: any, signedData: any, tx: any)`

Updates the transaction details on an external service using `axiosService` based on the job data and signed data received.

#### Parameters:

-   `job`: The job object containing data about the transaction.
-   `signedData`: The signed data of the transaction.
-   `tx`: The transaction details.

#### Actions:

-   Sends an update request for the transaction.
-   Removes the transaction hash from the local list upon successful update.
-   Handles errors and logs them.

### 4\. `getGeneratorHash(tx: any): string`

Generates a hash from the transaction's generator signature.

#### Parameters:

-   `tx`: The transaction object.

#### Actions:

-   Extracts the first signature hash if available.
-   Returns the hash or an empty string if none found.

Each of these functions plays a crucial role in processing and managing transactions within the multiswap validator node, handling everything from data fetching, signature verification, and transaction updating.

# web3.service.ts

The file `web3.service.ts` in the `multiswap-validator-node` repository contains several utility functions that interact with the Ethereum blockchain via Web3.js. Below, I have documented each function in detail:

### 1\. getTransactionReceipt

This asynchronous function retrieves the transaction receipt for a given transaction ID (`txId`) and chain ID (`chainId`). It attempts to retrieve the receipt up to a specified number of times (`threshold`). If the transaction receipt is not found after initial tries, it recursively attempts to retrieve it again after a delay, until the threshold is met.

### 2\. getTransactionByHash

Retrieves details about a transaction using its hash (`txHash`) and the chain ID (`chainId`). It utilizes a Web3 instance to directly call `getTransaction` with the transaction hash.

### 3\. signedTransaction

Processes a transaction for signing. It takes job data, decoded transaction data, and other parameters to prepare and sign a transaction. This function generates a transaction data object (`txData`), calculates a salt using a keccak256 hash function, and creates a signed transaction receipt using various transaction parameters.

### 4\. getLogsFromTransactionReceipt

Extracts and decodes logs from a transaction receipt based on the job data provided. It identifies relevant swap event logs, decodes them using the ABI definitions, and returns the decoded log data.

### 5\. findSwapEvent

A helper function that locates the index of a 'Swap' event from an array of topics. It hashes predefined event signatures and matches them against the topics array to find the relevant index.

### 6\. getFundManagerAddress

Returns the fund manager's address for a given chain ID by looking up a pre-defined list of network configurations (`NETWORKS`).

### 7\. getFiberRouterAddress

Similar to `getFundManagerAddress`, this function returns the address of the Fiber Router for a given chain ID by looking up the same network configurations.

### 8\. getFoundaryTokenAddress

Returns the Foundary token address for a specified chain ID, using the `NETWORKS` configurations.

### 9\. getDestinationAmount

A straightforward function that returns the 'swapBridgeAmount' from the provided data object.

### 10\. checkValidTransactionAndReturnReceipt

Checks if a transaction is valid by comparing the transaction's target address with the Fiber Router address for the given chain ID. If valid, it returns the transaction receipt; otherwise, it returns null.

### 11\. delay

A utility function that creates a delay (30 seconds) using JavaScript's `setTimeout`.

These functions collectively provide the necessary mechanisms to handle blockchain transactions, event logging, and address retrieval within the multi-chain environment of the Multiswap Validator Node.

